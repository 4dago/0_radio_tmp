/*
 * main.c
 *
 *  Created on: 10 mar 2018
 *      Author: dago
 */
#include <avr/io.h>
#include <avr/interrupt.h>
#include <util/delay.h>
#include <avr/pgmspace.h>
#include <string.h>
#include <stdlib.h>

#include "Si4703/Si4703.h"
#include "I2C_TWI/i2c_master.h"
#include "UART/mkuart.h"
#include "ssd1306/ssd1306.h"

void pokaz_rejestry (uint8_t start, uint8_t stop, uint16_t * bufor);



const uint8_t bitmap1[] PROGMEM = {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x0E,0x00,0x00,0x00,0x00,0x00,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x60,0x7F,0x00,0x00,0x00,0x00,0x04,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0xC0,0x01,0x07,0xC0,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x01,0x80,0x00,0x0C,0x60,0x00,0x08,0x04,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0xC0,0x00,0x30,0x40,0x00,0x06,0x04,0xF9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x60,0x00,0x00,0x40,0x00,0x02,0x06,0x0D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x20,0x00,0x01,0x80,0x00,0x00,0x0C,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x0E,0x00,0x07,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0xE3,0xF8,0x00,0x00,0x00,0x70,0x02,0x00,0x00,0x00,0x00,0x00,0x3C,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x02,0x00,0x00,0x00,0x00,0x03,0xE7,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x06,0x00,0x00,0x00,0x00,0x06,0x01,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x05,0x00,0x00,0x00,0x00,0x1C,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x14,0x00,0x00,0x00,0x00,0x22,0x10,0x80,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x04,0x10,0x00,0x00,0x00,0x86,0x00,0x80,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x7C,0x10,0x00,0x00,0x00,0x84,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x40,0x00,0x00,0x00,0x00,0x84,0x00,0x80,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,0x85,0xC1,0x80,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1A,0x00,0x00,0x00,0x00,0x00,0x00,0x61,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x19,0x20,0x00,0x00,0x00,0x00,0x40,0x05,0x00,
        0x00,0x00,0x07,0xCE,0x00,0x00,0x00,0x11,0x20,0x00,0x00,0x00,0x00,0x40,0x06,0x00,
        0x00,0x00,0x0C,0x03,0xE5,0xE0,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x10,0x0C,0x00,
        0x00,0x00,0x18,0x00,0x00,0x70,0x00,0x20,0x10,0x00,0x00,0x00,0x00,0x0E,0x78,0x00,
        0x00,0x00,0x20,0x00,0x01,0x90,0x00,0x60,0x10,0x00,0x00,0x00,0x00,0x06,0x00,0x00,
        0x00,0x00,0x40,0x00,0x07,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,
        0x00,0x01,0x80,0x00,0x1C,0x10,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x07,0x00,0x00,0x30,0x10,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00,
        0x00,0x0C,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x00,
        0x00,0x38,0x00,0x00,0xC0,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,
        0x00,0x7D,0xF0,0x00,0x80,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,
        0x00,0x40,0x05,0xF9,0x80,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,
        0x00,0x40,0x00,0x00,0x80,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x40,0x00,0x00,0x80,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x40,0x00,0x00,0x80,0x10,0x00,0x00,0x00,0x00,0x0F,0xFC,0x03,0xE0,0x00,0x00,
        0x00,0x60,0x00,0x00,0x40,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3E,0x00,0x00,
        0x00,0x20,0x00,0x00,0x20,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x61,0xC0,0x00,
        0x00,0x20,0x00,0x00,0x20,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x70,0x00,
        0x00,0x20,0x00,0x00,0x20,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x80,
        0x00,0x20,0x00,0x00,0x20,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,
        0x00,0x20,0x00,0x00,0x20,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,
        0x00,0x20,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x00,0x00,
        0x00,0x20,0x00,0x00,0x20,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,
        0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
        0x00,0x20,0x00,0x00,0xC0,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,
        0x00,0x20,0x00,0x01,0x80,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
        0x00,0x20,0x00,0x03,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x00,0x00,
        0x00,0x0E,0xF0,0x0C,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x80,0x00,0x00,
        0x00,0x38,0x1F,0xD8,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0xC0,0x00,0x00,
        0x00,0x00,0x00,0x03,0xA7,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,
        0x00,0x00,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x10,0x00,0x00,
        0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x18,0x00,0x00,
        0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x01,0x80,0x08,0x00,0x00,
        0x00,0x00,0x00,0x48,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x0C,0x00,0x00,
        0x00,0x00,0x00,0x07,0xF3,0x80,0x00,0x00,0x01,0xFD,0xE0,0x00,0x00,0x04,0x00,0x00,
        0x00,0x00,0x60,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0xC0,0x00,0x00,0x1C,0x1C,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x04,0x70,0x00,0x00,0x00,0x00,0x60,0x00,0x02,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x02,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x01,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,
};





int main(void) {
										// globalne przerwainia
	DDRB |= (1 << PB5);							// LED testowy

	USART_Init(__UBRR);						// Inicjalizacja UART
	i2c_init(I2CBITRATE);						//inicjalizacja i2c
	si4703_init();

    SSD1306_init( SSD1306_SWITCHCAPVCC, REFRESH_MID );

    SSD1306_cls(); // czyszczenie zawertosci bufora

    SSD1306_drawBitmap_P(0,0,bitmap1,128,64,1); // rysuj bitmape
    SSD1306_display();
    _delay_ms(1000);
    SSD1306_cls(); // czyszczenie zawertosci bufora


	sei();
	pokaz_rejestry(0x00, 0x0f, si4703_registers);


	fm_seek(1,rssi,sksnr, skcnt);
	fm_setVolume(5);


char rdsname[9] = "HELLO :)";
char rdsrt[65] = "Welcome to radio";

// SSD1306_cls(); // czyszczenie zawertosci bufora

/*for (int i = 130; i>-300;i-- ) {
	SSD1306_puts(i,page0*8,rdsname,1,1,0);
	SSD1306_refreshPages(page0,1,0,127);

}*/

// SSD1306_display();

	while (1) {


//		for (int i = 100; i>-100;i-- ) {
		SSD1306_puts(0,page0*8,rdsname,1,1,0);
		SSD1306_puts(0,page1*8,rdsrt,1,1,0);
		    SSD1306_display();
//			SSD1306_refreshPages(page0,2,0,128);
//		}
//		PORTB ^= (1 << PB5);
//		_delay_ms(3000);
//		kierunek = uart_getc();
		switch(uart_getc()) {
			case 'g':
				fm_seek(1,rssi,sksnr, skcnt);
				uart_putint(fm_getChannel10x(), 10);
				clearRDSBuff();
//				fm_readRDS(rdsdata, radiotext);

				break;
			case 'd':
				fm_seek(0,rssi,sksnr, skcnt);
				uart_putint(fm_getChannel10x(), 10);
				clearRDSBuff();

//				fm_readRDS(rdsdata, radiotext);

				break;
			case '+':
//				fm_readRDS(rdsdata, radiotext);
				fm_setVolume(glosnosc+1);
				uart_putint(glosnosc, 10);

				break;
			case '-':
//				fm_readRDS(rdsdata, radiotext);
				fm_setVolume(glosnosc-1);
				uart_putint(glosnosc, 10);
				break;
			case 'r':
//				uart_putint( fm_readRDS(rdsdata, radiotext), 10);
				uart_puts(rdsname);
				uart_puts("\n\r");
				uart_puts(rdsrt);
				uart_puts("\n\r");
				uart_putint(godziny+offsetutc/2, 10);
				uart_puts(":");
				uart_putint(minuty, 10);
				uart_puts(" , offset: ");
				uart_putint(offsetutc, 10);
				uart_puts("\n\r");
				break;
			case 's':
				pokaz_rejestry(0x00, 0x0f, si4703_registers);
				break;
		}
		fm_readRDS(rdsname, rdsrt);


	}

}

void pokaz_rejestry (uint8_t start, uint8_t stop, uint16_t * bufor){
	uart_puts("\n\r");
	for (uint8_t i = start; i <= stop; i++){
		uart_puts("Rejestr ");
		uart_putint(i, 16);
		uart_puts(":  ");
		uart_putint(*bufor++, 2);
		uart_puts("\n\r");
	}
}


void szukaj (void) {


}
